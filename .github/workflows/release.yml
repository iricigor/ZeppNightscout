name: ðŸš€ Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build from'
        required: true
        default: 'main'
        type: string

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.branch || github.ref }}
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Get version and build number
      id: get_version
      run: |
        # Last modification done in PR iricigor/ZeppNightscout#49
        echo "Last modification to release pipeline: PR #49"
        
        # Read base version from app.json
        BASE_VERSION=$(node -p "require('./app.json').app.version.name")
        
        # Extract major.minor from base version (e.g., "0.1.0" -> "0.1")
        MAJOR_MINOR=$(echo $BASE_VERSION | cut -d. -f1,2)
        
        # Use GitHub run number as patch version
        BUILD_VERSION="${MAJOR_MINOR}.${{ github.run_number }}"
        
        # For tagged releases, extract tag version
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          TAG=${GITHUB_REF#refs/tags/}
          echo "VERSION=$BUILD_VERSION" >> $GITHUB_OUTPUT
          echo "TAG=$TAG" >> $GITHUB_OUTPUT
          echo "BASE_VERSION=$TAG_VERSION" >> $GITHUB_OUTPUT
        else
          # For manual dispatch, use build version
          TAG="v${BUILD_VERSION}"
          echo "VERSION=$BUILD_VERSION" >> $GITHUB_OUTPUT
          echo "TAG=$TAG" >> $GITHUB_OUTPUT
          echo "BASE_VERSION=$BUILD_VERSION" >> $GITHUB_OUTPUT
        fi
        
        echo "Building version: $BUILD_VERSION"
    
    - name: Update app.json with build version
      run: |
        # Update version in app.json to include run number
        node -e "
          try {
            const fs = require('fs');
            const app = JSON.parse(fs.readFileSync('app.json', 'utf8'));
            app.app.version.name = '${{ steps.get_version.outputs.VERSION }}';
            fs.writeFileSync('app.json', JSON.stringify(app, null, 2) + '\n');
            console.log('Successfully updated app.json version to ${{ steps.get_version.outputs.VERSION }}');
          } catch (error) {
            console.error('Failed to update app.json:', error.message);
            process.exit(1);
          }
        "
        cat app.json | grep -A2 '"version"'
    
    - name: Update workflow run name with version
      run: echo "::notice title=Release Version::Building release ${{ steps.get_version.outputs.VERSION }}"
    
    - name: Install Zeus CLI
      run: npm install -g @zeppos/zeus-cli
    
    - name: Configure Zeus CLI authentication
      env:
        ZEPP_APP_TOKEN: ${{ secrets.ZEPP_APP_TOKEN }}
        ZEPP_USER_ID: ${{ secrets.ZEPP_USER_ID }}
        ZEPP_CNAME: ${{ secrets.ZEPP_CNAME }}
      run: |
        # Check if authentication tokens are available
        if [ -z "$ZEPP_APP_TOKEN" ] || [ -z "$ZEPP_USER_ID" ] || [ -z "$ZEPP_CNAME" ]; then
          echo "::warning::ZEPP_APP_TOKEN, ZEPP_USER_ID, or ZEPP_CNAME secrets not set. Skipping Zeus authentication."
          echo "::warning::Zeus preview QR code will not be generated."
          echo "ZEUS_LOGIN_SUCCESS=false" >> $GITHUB_ENV
          exit 0
        fi
        
        # Configure Zeus CLI with authentication tokens using zeus config set
        # Verified: zeus config set supports multiple key=value pairs in a single command
        zeus config set \
          "____user_zepp_com__token=$ZEPP_APP_TOKEN" \
          "____user_zepp_com__userid=$ZEPP_USER_ID" \
          "____user_zepp_com__cname=$ZEPP_CNAME"
        
        if [ $? -eq 0 ]; then
          echo "ZEUS_LOGIN_SUCCESS=true" >> $GITHUB_ENV
          echo "âœ… Successfully configured Zeus CLI authentication"
        else
          echo "ZEUS_LOGIN_SUCCESS=false" >> $GITHUB_ENV
          echo "::warning::Zeus authentication configuration failed. Preview QR code will not be generated."
        fi
    
    - name: Build app with Zeus
      run: zeus build
    
    - name: Generate Zeus Preview QR Code
      id: zeus_preview
      if: env.ZEUS_LOGIN_SUCCESS == 'true'
      run: |
        # Last modification done in PR iricigor/ZeppNightscout#50
        echo "Last modification to Zeus Preview QR Code generation: PR #50"
        echo "Pipeline run number: ${{ github.run_number }}"
        
        # Install tools: qrencode/imagemagick for QR generation, expect for device selection automation
        echo "Installing required tools (qrencode, imagemagick, expect)..."
        if ! sudo DEBIAN_FRONTEND=noninteractive apt-get update -qq > /dev/null 2>&1; then
          echo "::error::Failed to update package lists"
          exit 1
        fi
        if ! sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq qrencode imagemagick expect > /dev/null 2>&1; then
          echo "::error::Failed to install required tools"
          exit 1
        fi
        echo "âœ… Tools installed successfully"
        
        # Note: expect automates the interactive device selection in 'zeus preview'
        # (Zeus CLI doesn't provide a command-line option for this)
        
        # Run zeus preview and capture output
        echo "Running zeus preview to generate QR code..."
        
        # Use timeout wrapper to prevent indefinite hanging (45 seconds max)
        # This provides a hard limit even if expect script itself hangs
        # Use expect to automate the device selection and capture all output
        set +e  # Temporarily disable exit-on-error to capture exit code
        PREVIEW_OUTPUT=$(timeout 45 expect -c "
          # Set timeout to 30 seconds - sufficient for device selection and URL generation
          set timeout 30
          log_user 1
          log_file -noappend /tmp/zeus_preview.log
          
          spawn zeus preview
          
          # Handle device selection and URL generation
          # Two scenarios: 1) Device selection prompt appears, 2) Direct URL output
          expect {
            \"Select a target device\" {
              send \"1\r\"
              # After selecting device, wait for the URL or completion
              expect {
                -re \"(zepp://[^\\s\\r\\n\\\"]+|https://[a-zA-Z0-9./?&=_-]+)\" {
                  # Give it a moment to output the full URL
                  sleep 1
                  puts \"\\nURL detected, exiting...\"
                }
                timeout {
                  puts \"\\nTimeout after device selection\"
                }
                eof {
                  puts \"\\nCommand completed (EOF)\"
                }
              }
            }
            -re \"(zepp://[^\\s\\r\\n\\\"]+|https://[a-zA-Z0-9./?&=_-]+)\" {
              # URL appeared without device selection prompt
              sleep 1
              puts \"\\nURL detected without device selection, exiting...\"
            }
            timeout {
              puts \"\\nTimeout waiting for device selection prompt\"
            }
            eof {
              puts \"\\nCommand completed (no device selection needed)\"
            }
          }
          
          # Force exit to prevent hanging
          catch {
            # Try to close the spawned process gracefully
            close
          }
          catch {
            wait
          }
          exit 0
        " 2>&1)
        EXPECT_EXIT_CODE=$?
        set -e  # Re-enable exit-on-error
        
        # Check if the command timed out (timeout command returns exit code 124)
        if [ $EXPECT_EXIT_CODE -eq 124 ]; then
          echo "::warning::Zeus preview command timed out after 45 seconds"
        fi
        
        echo "Preview output:"
        echo "$PREVIEW_OUTPUT"
        
        # Also show the log file if it exists
        if [ -f /tmp/zeus_preview.log ]; then
          echo "Full log file contents:"
          cat /tmp/zeus_preview.log
        fi
        
        # Helper function to extract URL from text
        extract_url() {
          local text="$1"
          # First try zepp:// deep link format (preferred)
          local url=$(echo "$text" | grep -oP 'zepp://[^\s\r\n"]+' | head -1 || echo "")
          # If no zepp:// URL found, try https:// format
          if [ -z "$url" ]; then
            url=$(echo "$text" | grep -oP 'https://[a-zA-Z0-9./?&=_-]+' | head -1 || echo "")
          fi
          echo "$url"
        }
        
        # Try to extract the preview URL from output
        PREVIEW_URL=$(extract_url "$PREVIEW_OUTPUT")
        
        # Also check the log file if URL not found in stdout
        if [ -z "$PREVIEW_URL" ] && [ -f /tmp/zeus_preview.log ]; then
          PREVIEW_URL=$(extract_url "$(cat /tmp/zeus_preview.log)")
        fi
        
        if [ -n "$PREVIEW_URL" ]; then
          echo "PREVIEW_URL=$PREVIEW_URL" >> $GITHUB_OUTPUT
          echo "âœ… Zeus preview URL generated: $PREVIEW_URL"
          
          # Generate QR code image from the preview URL
          qrencode -s 10 -o zeus_preview_qr.png "$PREVIEW_URL"
          echo "ZEUS_QR_GENERATED=true" >> $GITHUB_OUTPUT
          echo "âœ… QR code image saved to zeus_preview_qr.png"
        else
          echo "::warning::Could not extract preview URL from zeus preview output"
          echo "ZEUS_QR_GENERATED=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Upload Zeus QR Code as artifact
      if: env.ZEUS_LOGIN_SUCCESS == 'true' && steps.zeus_preview.outputs.ZEUS_QR_GENERATED == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: zeus-preview-qr
        path: zeus_preview_qr.png
        retention-days: 90
    
    - name: Find build artifacts
      id: find_artifacts
      run: |
        # Find all .zab files (Zepp App Bundle)
        # Zeus CLI outputs to dist/ directory
        if [ -f "dist/com.nightscout.zepp.zab" ]; then
          echo "ARTIFACT_PATH=dist/com.nightscout.zepp.zab" >> $GITHUB_OUTPUT
          echo "ARTIFACT_NAME=com.nightscout.zepp.zab" >> $GITHUB_OUTPUT
        elif [ -d "dist" ]; then
          ZAB_FILE=$(find dist -name "*.zab" | head -n 1)
          if [ -n "$ZAB_FILE" ]; then
            echo "ARTIFACT_PATH=$ZAB_FILE" >> $GITHUB_OUTPUT
            echo "ARTIFACT_NAME=$(basename $ZAB_FILE)" >> $GITHUB_OUTPUT
          else
            echo "::error::No .zab file found in dist directory"
            exit 1
          fi
        else
          echo "::error::Build output directory (dist/) not found"
          exit 1
        fi
        
        # List what we have
        echo "Build artifacts:"
        ls -la dist/ || echo "No dist directory"
    
    - name: Generate QR code for download
      id: qr_code
      run: |
        # Generate download URL
        DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.TAG }}/${{ steps.find_artifacts.outputs.ARTIFACT_NAME }}"
        echo "DOWNLOAD_URL=$DOWNLOAD_URL" >> $GITHUB_OUTPUT

        # Generate QR code using api.qrserver.com service
        QR_URL="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${DOWNLOAD_URL}"
        echo "QR_URL=$QR_URL" >> $GITHUB_OUTPUT
    
    - name: Create Release Notes
      id: release_notes
      run: |
        cat > release_notes.md << 'EOF'
        ## ZeppNightscout ${{ steps.get_version.outputs.VERSION }}
        
        **Build**: #${{ github.run_number }} | **Base Version**: ${{ steps.get_version.outputs.BASE_VERSION }} | **Branch**: ${{ github.event.inputs.branch || github.ref_name }}
        
        ### Download
        
        Download the app: [${{ steps.find_artifacts.outputs.ARTIFACT_NAME }}](${{ steps.qr_code.outputs.DOWNLOAD_URL }})
        
        EOF
        
        # Add Zeus Preview QR Code section if available
        if [ "${{ steps.zeus_preview.outputs.ZEUS_QR_GENERATED }}" == "true" ]; then
          # Generate URL for the uploaded QR code artifact
          QR_IMAGE_URL="https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.TAG }}/zeus_preview_qr.png"
          cat >> release_notes.md << EOF
        ### ðŸš€ Quick Install via Zepp App (Recommended)
        
        **Scan this QR code with the Zepp App on your phone to install directly to your watch:**
        
        ![Zeus Preview QR Code](${QR_IMAGE_URL})
        
        > **Note:** This QR code connects directly to the Zepp platform for instant installation via the Zepp App's Developer Mode.
        > Make sure Developer Mode is enabled in your Zepp App (Profile â†’ Settings â†’ About â†’ tap Zepp icon 7 times).
        
        EOF
        fi
        
        cat >> release_notes.md << 'EOF'
        ### Alternative: Download QR Code
        
        Scan this QR code with your phone to download the `.zab` file:
        
        ![Download QR Code](${{ steps.qr_code.outputs.QR_URL }})
        
        ### Installation Instructions
        
        1. **Option 1 - Zeus Preview QR Code (Fastest)** â­
           - Enable Developer Mode in Zepp App (Profile â†’ Settings â†’ About â†’ tap Zepp icon 7 times)
           - Open Zepp App â†’ Profile â†’ Your Device â†’ Developer Mode
           - Tap "Scan" and scan the Zeus Preview QR code above
           - App installs directly to your watch!
        
        2. **Option 2 - Download QR Code**
           - Scan the Download QR code above with your phone
           - Download the `.zab` file
           - Use the Zepp app to install it on your watch
        
        3. **Option 3 - Direct Download**
           - Click the download link above
           - Transfer the `.zab` file to your phone
           - Use the Zepp app to install it on your watch
        
        4. **Option 4 - Zeus CLI**
           - Download the release artifact
           - Use `zeus preview` or `zeus install` commands
        
        ### What's Included
        
        - App version: ${{ steps.get_version.outputs.VERSION }}
        - Build number: ${{ github.run_number }}
        - Compatible with Zepp OS devices
        - Built from commit: ${{ github.sha }}
        
        ### Support
        
        For issues and questions, please visit the [GitHub repository](${{ github.server_url }}/${{ github.repository }}).
        EOF
        
        cat release_notes.md
    
    - name: Prepare release files list
      id: release_files
      run: |
        FILES="${{ steps.find_artifacts.outputs.ARTIFACT_PATH }}"
        if [ "${{ steps.zeus_preview.outputs.ZEUS_QR_GENERATED }}" == "true" ]; then
          FILES="$FILES"$'\n'"zeus_preview_qr.png"
        fi
        echo "files<<EOF" >> $GITHUB_OUTPUT
        echo "$FILES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.TAG }}
        name: Release ${{ steps.get_version.outputs.VERSION }}
        body_path: release_notes.md
        files: ${{ steps.release_files.outputs.files }}
        draft: false
        prerelease: ${{ github.event_name == 'workflow_dispatch' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
