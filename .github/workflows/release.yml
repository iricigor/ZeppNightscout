name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Get version from tag
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
    
    - name: Update workflow run name with version
      run: echo "::notice title=Release Version::Building release ${{ steps.get_version.outputs.VERSION }}"
    
    - name: Install Zeus CLI
      run: npm install -g @zeppos/zeus-cli
    
    # Setup offline device cache to allow zeus build to run without internet
    # expiredTime is set to far future (year 2286) to prevent cache expiration
    - name: Setup Zeus device cache
      run: |
        mkdir -p ~/.zepp
        cat > ~/.zepp/.zeus_devices << 'EOF'
        {
          "devices": [
            {
              "productName": "gtr-3",
              "deviceSource": "gtr-3",
              "code": "gtr-3",
              "value": {
                "shape": "round",
                "screen": {
                  "size": "454*454"
                },
                "os": {
                  "apiLevel": "1.0.1",
                  "apiLevelLimitMin": "1.0.0",
                  "apiLevelLimitMax": "2.0.0"
                }
              }
            }
          ],
          "devices_beta": [],
          "expiredTime": 9999999999999,
          "version": "1.8.1"
        }
        EOF
    
    - name: Build app with Zeus
      run: zeus build
    
    - name: Find build artifacts
      id: find_artifacts
      run: |
        # Find all .zab files (Zepp App Bundle)
        if [ -f "output/com.nightscout.zepp.zab" ]; then
          echo "ARTIFACT_PATH=output/com.nightscout.zepp.zab" >> $GITHUB_OUTPUT
          echo "ARTIFACT_NAME=com.nightscout.zepp.zab" >> $GITHUB_OUTPUT
        elif [ -d "output" ]; then
          ZAB_FILE=$(find output -name "*.zab" | head -n 1)
          if [ -n "$ZAB_FILE" ]; then
            echo "ARTIFACT_PATH=$ZAB_FILE" >> $GITHUB_OUTPUT
            echo "ARTIFACT_NAME=$(basename $ZAB_FILE)" >> $GITHUB_OUTPUT
          else
            echo "::error::No .zab file found in output directory"
            exit 1
          fi
        else
          echo "::error::Output directory not found"
          exit 1
        fi
        
        # List what we have
        echo "Build artifacts:"
        ls -la output/ || echo "No output directory"
    
    - name: Generate QR code for download
      id: qr_code
      run: |
        # Generate download URL
        DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.TAG }}/${{ steps.find_artifacts.outputs.ARTIFACT_NAME }}"
        echo "DOWNLOAD_URL=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
        
        # Generate QR code using GitHub's QR code service
        QR_URL="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${DOWNLOAD_URL}"
        echo "QR_URL=$QR_URL" >> $GITHUB_OUTPUT
    
    - name: Create Release Notes
      id: release_notes
      run: |
        cat > release_notes.md << 'EOF'
        ## ZeppNightscout ${{ steps.get_version.outputs.VERSION }}
        
        ### Download
        
        Download the app: [${{ steps.find_artifacts.outputs.ARTIFACT_NAME }}](${{ steps.qr_code.outputs.DOWNLOAD_URL }})
        
        ### Quick Install via QR Code
        
        Scan this QR code with your phone to download the app directly:
        
        ![QR Code](${{ steps.qr_code.outputs.QR_URL }})
        
        ### Installation Instructions
        
        1. **Option 1 - QR Code (Recommended)**
           - Scan the QR code above with your phone
           - Download the `.zab` file
           - Use the Zepp app to install it on your watch
        
        2. **Option 2 - Direct Download**
           - Click the download link above
           - Transfer the `.zab` file to your phone
           - Use the Zepp app to install it on your watch
        
        3. **Option 3 - Zeus CLI**
           - Download the release artifact
           - Use `zeus preview` or `zeus install` commands
        
        ### What's Included
        
        - App version: ${{ steps.get_version.outputs.VERSION }}
        - Compatible with Zepp OS devices
        - Built from commit: ${{ github.sha }}
        
        ### Support
        
        For issues and questions, please visit the [GitHub repository](${{ github.server_url }}/${{ github.repository }}).
        EOF
        
        cat release_notes.md
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.TAG }}
        name: Release ${{ steps.get_version.outputs.VERSION }}
        body_path: release_notes.md
        files: |
          ${{ steps.find_artifacts.outputs.ARTIFACT_PATH }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
