name: ðŸš€ Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build from'
        required: true
        default: 'main'
        type: string

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.branch || github.ref }}
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Get version and build number
      id: get_version
      run: |
        # Read base version from app.json
        BASE_VERSION=$(node -p "require('./app.json').app.version.name")
        
        # Extract major.minor from base version (e.g., "0.1.0" -> "0.1")
        MAJOR_MINOR=$(echo $BASE_VERSION | cut -d. -f1,2)
        
        # Use GitHub run number as patch version
        BUILD_VERSION="${MAJOR_MINOR}.${{ github.run_number }}"
        
        # For tagged releases, extract tag version
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          TAG=${GITHUB_REF#refs/tags/}
          echo "VERSION=$BUILD_VERSION" >> $GITHUB_OUTPUT
          echo "TAG=$TAG" >> $GITHUB_OUTPUT
          echo "BASE_VERSION=$TAG_VERSION" >> $GITHUB_OUTPUT
        else
          # For manual dispatch, use build version
          TAG="v${BUILD_VERSION}"
          echo "VERSION=$BUILD_VERSION" >> $GITHUB_OUTPUT
          echo "TAG=$TAG" >> $GITHUB_OUTPUT
          echo "BASE_VERSION=$BUILD_VERSION" >> $GITHUB_OUTPUT
        fi
        
        echo "Building version: $BUILD_VERSION"
    
    - name: Update app.json with build version
      run: |
        # Update version in app.json to include run number
        node -e "
          try {
            const fs = require('fs');
            const app = JSON.parse(fs.readFileSync('app.json', 'utf8'));
            app.app.version.name = '${{ steps.get_version.outputs.VERSION }}';
            fs.writeFileSync('app.json', JSON.stringify(app, null, 2) + '\n');
            console.log('Successfully updated app.json version to ${{ steps.get_version.outputs.VERSION }}');
          } catch (error) {
            console.error('Failed to update app.json:', error.message);
            process.exit(1);
          }
        "
        cat app.json | grep -A2 '"version"'
    
    - name: Update workflow run name with version
      run: echo "::notice title=Release Version::Building release ${{ steps.get_version.outputs.VERSION }}"
    
    - name: Install Zeus CLI
      run: npm install -g @zeppos/zeus-cli
    
    - name: Install expect for automated login
      run: sudo apt-get update && sudo apt-get install -y expect
    
    - name: Login to Zeus CLI
      env:
        ZEPP_USERNAME: ${{ secrets.ZEPP_USERNAME }}
        ZEPP_PASSWORD: ${{ secrets.ZEPP_PASSWORD }}
      run: |
        # Check if credentials are available
        if [ -z "$ZEPP_USERNAME" ] || [ -z "$ZEPP_PASSWORD" ]; then
          echo "::warning::ZEPP_USERNAME or ZEPP_PASSWORD secrets not set. Skipping Zeus login."
          echo "::warning::Zeus preview QR code will not be generated."
          echo "ZEUS_LOGIN_SUCCESS=false" >> $GITHUB_ENV
          exit 0
        fi
        
        # Use expect to automate zeus login
        expect -c "
          set timeout 30
          spawn zeus login
          expect {
            \"email\" {
              send \"$ZEPP_USERNAME\r\"
              exp_continue
            }
            \"password\" {
              send \"$ZEPP_PASSWORD\r\"
              exp_continue
            }
            \"successfully\" {
              exit 0
            }
            timeout {
              puts \"Login timeout\"
              exit 1
            }
            eof
          }
        "
        
        if [ $? -eq 0 ]; then
          echo "ZEUS_LOGIN_SUCCESS=true" >> $GITHUB_ENV
          echo "âœ… Successfully logged in to Zeus CLI"
        else
          echo "ZEUS_LOGIN_SUCCESS=false" >> $GITHUB_ENV
          echo "::warning::Zeus login failed. Preview QR code will not be generated."
        fi
    
    - name: Setup Zeus device cache
      run: |
        mkdir -p ~/.zepp
        # expiredTime is set to 9999999999999 (year 2286) to prevent cache expiration
        # This allows zeus build to run offline in CI without fetching device data
        cat > ~/.zepp/.zeus_devices << 'EOF'
        {
          "devices": [
            {
              "productName": "gtr-3",
              "deviceSource": 226,
              "code": "gtr-3",
              "value": {
                "shape": "round",
                "screen": {
                  "size": "454*454"
                },
                "os": {
                  "apiLevel": "1.0.1",
                  "apiLevelLimitMin": "1.0.0",
                  "apiLevelLimitMax": "2.0.0"
                }
              }
            },
            {
              "productName": "gtr-3w",
              "deviceSource": 227,
              "code": "gtr-3w",
              "value": {
                "shape": "round",
                "screen": {
                  "size": "454*454"
                },
                "os": {
                  "apiLevel": "1.0.1",
                  "apiLevelLimitMin": "1.0.0",
                  "apiLevelLimitMax": "2.0.0"
                }
              }
            }
          ],
          "devices_beta": [],
          "expiredTime": 9999999999999,
          "version": "1.8.1"
        }
        EOF
    
    - name: Build app with Zeus
      run: zeus build
    
    - name: Generate Zeus Preview QR Code
      id: zeus_preview
      if: env.ZEUS_LOGIN_SUCCESS == 'true'
      run: |
        # Install qrencode to generate QR code from URL if needed
        sudo apt-get install -y qrencode imagemagick
        
        # Run zeus preview and capture output
        # The preview command will generate a QR code in terminal
        # We need to capture the preview URL from the output
        echo "Running zeus preview to generate QR code..."
        
        # Use expect to automate the device selection and capture QR code
        PREVIEW_OUTPUT=$(expect -c "
          set timeout 60
          log_user 0
          spawn zeus preview
          expect {
            \"Select a target device\" {
              send \"1\r\"
              exp_continue
            }
            \"preview url\" {
              set output \$expect_out(buffer)
              puts \$output
              exp_continue
            }
            \"https://\" {
              set output \$expect_out(buffer)
              puts \$output
              exp_continue  
            }
            timeout {
              puts \"Preview timeout\"
              exit 1
            }
            eof
          }
        " 2>&1) || true
        
        echo "Preview output:"
        echo "$PREVIEW_OUTPUT"
        
        # Try to extract the preview URL from output
        PREVIEW_URL=$(echo "$PREVIEW_OUTPUT" | grep -oP 'https://[^\s]+' | head -1 || echo "")
        
        if [ -n "$PREVIEW_URL" ]; then
          echo "PREVIEW_URL=$PREVIEW_URL" >> $GITHUB_OUTPUT
          echo "âœ… Zeus preview URL generated: $PREVIEW_URL"
          
          # Generate QR code image from the preview URL
          qrencode -s 10 -o zeus_preview_qr.png "$PREVIEW_URL"
          echo "ZEUS_QR_GENERATED=true" >> $GITHUB_OUTPUT
          echo "âœ… QR code image saved to zeus_preview_qr.png"
        else
          echo "::warning::Could not extract preview URL from zeus preview output"
          echo "ZEUS_QR_GENERATED=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Upload Zeus QR Code as artifact
      if: env.ZEUS_LOGIN_SUCCESS == 'true' && steps.zeus_preview.outputs.ZEUS_QR_GENERATED == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: zeus-preview-qr
        path: zeus_preview_qr.png
        retention-days: 90
    
    - name: Find build artifacts
      id: find_artifacts
      run: |
        # Find all .zab files (Zepp App Bundle)
        # Zeus CLI outputs to dist/ directory
        if [ -f "dist/com.nightscout.zepp.zab" ]; then
          echo "ARTIFACT_PATH=dist/com.nightscout.zepp.zab" >> $GITHUB_OUTPUT
          echo "ARTIFACT_NAME=com.nightscout.zepp.zab" >> $GITHUB_OUTPUT
        elif [ -d "dist" ]; then
          ZAB_FILE=$(find dist -name "*.zab" | head -n 1)
          if [ -n "$ZAB_FILE" ]; then
            echo "ARTIFACT_PATH=$ZAB_FILE" >> $GITHUB_OUTPUT
            echo "ARTIFACT_NAME=$(basename $ZAB_FILE)" >> $GITHUB_OUTPUT
          else
            echo "::error::No .zab file found in dist directory"
            exit 1
          fi
        else
          echo "::error::Build output directory (dist/) not found"
          exit 1
        fi
        
        # List what we have
        echo "Build artifacts:"
        ls -la dist/ || echo "No dist directory"
    
    - name: Generate QR code for download
      id: qr_code
      run: |
        # Generate download URL
        DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.TAG }}/${{ steps.find_artifacts.outputs.ARTIFACT_NAME }}"
        echo "DOWNLOAD_URL=$DOWNLOAD_URL" >> $GITHUB_OUTPUT

        # Generate QR code using api.qrserver.com service
        QR_URL="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${DOWNLOAD_URL}"
        echo "QR_URL=$QR_URL" >> $GITHUB_OUTPUT
    
    - name: Create Release Notes
      id: release_notes
      run: |
        cat > release_notes.md << 'EOF'
        ## ZeppNightscout ${{ steps.get_version.outputs.VERSION }}
        
        **Build**: #${{ github.run_number }} | **Base Version**: ${{ steps.get_version.outputs.BASE_VERSION }} | **Branch**: ${{ github.event.inputs.branch || github.ref_name }}
        
        ### Download
        
        Download the app: [${{ steps.find_artifacts.outputs.ARTIFACT_NAME }}](${{ steps.qr_code.outputs.DOWNLOAD_URL }})
        
        EOF
        
        # Add Zeus Preview QR Code section if available
        if [ "${{ steps.zeus_preview.outputs.ZEUS_QR_GENERATED }}" == "true" ]; then
          # Generate URL for the uploaded QR code artifact
          QR_IMAGE_URL="https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.TAG }}/zeus_preview_qr.png"
          cat >> release_notes.md << EOF
        ### ðŸš€ Quick Install via Zepp App (Recommended)
        
        **Scan this QR code with the Zepp App on your phone to install directly to your watch:**
        
        ![Zeus Preview QR Code](${QR_IMAGE_URL})
        
        > **Note:** This QR code connects directly to the Zepp platform for instant installation via the Zepp App's Developer Mode.
        > Make sure Developer Mode is enabled in your Zepp App (Profile â†’ Settings â†’ About â†’ tap Zepp icon 7 times).
        
        EOF
        fi
        
        cat >> release_notes.md << 'EOF'
        ### Alternative: Download QR Code
        
        Scan this QR code with your phone to download the `.zab` file:
        
        ![Download QR Code](${{ steps.qr_code.outputs.QR_URL }})
        
        ### Installation Instructions
        
        1. **Option 1 - Zeus Preview QR Code (Fastest)** â­
           - Enable Developer Mode in Zepp App (Profile â†’ Settings â†’ About â†’ tap Zepp icon 7 times)
           - Open Zepp App â†’ Profile â†’ Your Device â†’ Developer Mode
           - Tap "Scan" and scan the Zeus Preview QR code above
           - App installs directly to your watch!
        
        2. **Option 2 - Download QR Code**
           - Scan the Download QR code above with your phone
           - Download the `.zab` file
           - Use the Zepp app to install it on your watch
        
        3. **Option 3 - Direct Download**
           - Click the download link above
           - Transfer the `.zab` file to your phone
           - Use the Zepp app to install it on your watch
        
        4. **Option 4 - Zeus CLI**
           - Download the release artifact
           - Use `zeus preview` or `zeus install` commands
        
        ### What's Included
        
        - App version: ${{ steps.get_version.outputs.VERSION }}
        - Build number: ${{ github.run_number }}
        - Compatible with Zepp OS devices
        - Built from commit: ${{ github.sha }}
        
        ### Support
        
        For issues and questions, please visit the [GitHub repository](${{ github.server_url }}/${{ github.repository }}).
        EOF
        
        cat release_notes.md
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.TAG }}
        name: Release ${{ steps.get_version.outputs.VERSION }}
        body_path: release_notes.md
        files: |
          ${{ steps.find_artifacts.outputs.ARTIFACT_PATH }}
          ${{ steps.zeus_preview.outputs.ZEUS_QR_GENERATED == 'true' && 'zeus_preview_qr.png' || '' }}
        draft: false
        prerelease: ${{ github.event_name == 'workflow_dispatch' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
