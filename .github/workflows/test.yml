name: Test

on:
  pull_request:
    branches: [ main, master ]
  push:
    branches: [ main, master ]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Check JavaScript syntax
      run: npm run test:syntax
      
    - name: Run unit tests
      run: npm test
      
    - name: Validate build requirements
      run: npm run test:build
      
    - name: Install Zeus CLI
      run: npm install -g @zeppos/zeus-cli
      
    # Setup offline device cache to allow zeus build to run without internet
    # expiredTime is set to far future (year 2286) to prevent cache expiration
    - name: Setup Zeus device cache
      run: |
        mkdir -p ~/.zepp
        cat > ~/.zepp/.zeus_devices << 'EOF'
        {
          "devices": [
            {
              "productName": "gtr-3",
              "deviceSource": 226,
              "code": "gtr-3",
              "value": {
                "shape": "round",
                "screen": {
                  "size": "454*454"
                },
                "os": {
                  "apiLevel": "1.0.1",
                  "apiLevelLimitMin": "1.0.0",
                  "apiLevelLimitMax": "2.0.0"
                }
              }
            },
            {
              "productName": "gtr-3w",
              "deviceSource": 227,
              "code": "gtr-3w",
              "value": {
                "shape": "round",
                "screen": {
                  "size": "454*454"
                },
                "os": {
                  "apiLevel": "1.0.1",
                  "apiLevelLimitMin": "1.0.0",
                  "apiLevelLimitMax": "2.0.0"
                }
              }
            }
          ],
          "devices_beta": [],
          "expiredTime": 9999999999999,
          "version": "1.8.1"
        }
        EOF
    
    - name: Build app with Zeus
      run: zeus build
      
    - name: Test help command
      run: npm run help
